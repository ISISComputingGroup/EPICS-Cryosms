#
# Simple database and stream protocol file for basic SCPI (IEEE488.2) commands
#


#
# Short and long form of identification string
#

record(bo, "$(P)ABORT:SP")
{
    field(DESC, "Abort the current ramp")
    field(SDIS, "$(P)DISABLE")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(ai, "$(P)CONSTANT")
{
    field(DESC, "Tesla/Amp conversion rate")
    field(VAL, "$(T_TO_A)")
}

record(mbbi, "$(P)DIRECTION")
{
    field(DESC, "The direction of the device")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getDirection $(PORT)")
    field(ZRST, "0")
    field(ONST, "-")
    field(TWST, "+")
}

record(bo, "$(P)DISABLE")
{
  field(DESC, "Disable comms")
  field(PINI, "YES")
  field(VAL, "$(DISABLE=0)")
  field(OMSL, "supervisory")
  field(ZNAM, "COMMS ENABLED")
  field(ONAM, "COMMS DISABLED")
}

record(bi, "$(P)FAST:ZERO")
{
    field(ONAM, "True")
    field(ZNAM, "False")
}

record(bi, "$(P)HEATER:STAT")
{
    field(DESC, "The status of the heater from the device")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getHeaterStatus $(PORT)")
    field(SCAN, "Passive")
    field(ZNAM, "Off")
    field(ONAM, "On")
}

record(bo, "$(P)INIT")
{
    field(DESC, "starts init script")
    field(PINI, "1")
    field(DTYP, "asynInt32")
    field(OUT, "@asyn($(ASYN_PORT),0,0)INIT_LOGIC")
}

### MAGNET:

record(bo, "$(P)MAGNET:MODE")
{
    field(DESC, "Run the magnet in persistent mode or not")
    field(SDIS, "$(P)DISABLE")
}

record(ao, "$(P)MAX:SP")
{
    field(DESC, "The maximum value to allow in PSU Units")
    field(EGU, "$(DISPLAY_UNIT)")
}

record(ai, "$(P)MID")
{
    field(DESC, "ramp target read from device")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getMidTarget $(PORT)")
    field(SCAN, "Passive")
}

record(ao, "$(P)MID:SP")
{
    field(DESC, "current ramp target in PSU Units")
    field(EGU, "$(WRITE_UNIT)")
}

### OUTPUT:

record(scalcout, "$(P)OUTPUT")
{
    field(DESC, "Output from the PSU in $(DISPLAY_UNIT)")
    field(FLNK, "$(P)GAUSS")
    field(EGU, "$(DISPLAY_UNIT)")
    field(SDIS, "$(P)DISABLE")
    field(INPA, "$(P)OUTPUT:CURR")
    field(INPB, "$(P)OUTPUT:FIELD:TESLA")
    field(INPC, "$(P)OUTPUT:FIELD:GAUSS")
    field(INPD, "$(DISPLAY_UNIT)")
    field(CALC, "D==\"AMPS\"?A:D==\"TESLA\"?B:C")
}

record(calc, "$(P)OUTPUT:COIL")
{
    field(DESC, "Current through the coil")# OUTPUT:PERSIST if in persistent mode, otherwise OUTPUT
    field(CALC, "A=1?B:C")
    field(INPA, "$(P)MAGNET:MODE")
    field(INPB, "(P)OUTPUT:PERSIST")
    field(INPC, "$(P)OUTPUT")
    field(EGU, "$(DISPLAY_UNIT)")
    field(SDIS, "$(P)DISABLE")
}

record(scalcout, "$(P)OUTPUT:CURR")
{
    field(DESC, "OUTPUT:RAW in Amps")
    field(INPA, "$(P)OUTPUT:RAW:UNIT")
    field(INPB, "$(P)OUTPUT:RAW")
    field(CALC, "A==\"AMPS\"?B:B*$(T_TO_A)")
}

record(scalcout, "$(P)OUTPUT:FIELD:GAUSS")
{
    field(DESC, "OUTPUT:RAW in Gauss")
    field(INPA, "$(P)OUTPUT:RAW:UNIT")
    field(INPB, "$(P)OUTPUT:RAW")
    field(CALC, "A==\"TESLA\"?B*10000:B*10000/$(T_TO_A)")
}

record(scalcout, "$(P)OUTPUT:FIELD:TESLA")
{
    field(DESC, "OUTPUT:RAW in Tesla")
    field(INPA, "$(P)OUTPUT:RAW:UNIT")
    field(INPB, "$(P)OUTPUT:RAW")
    field(CALC, "A==\"TESLA\"?B:B/$(T_TO_A)")
}

record(scalcout, "$(P)OUTPUT:PERSIST")
{
    field(DESC, "Persistent output in $(DISPLAY_UNIT)")
    field(PREC, "3")
    field(EGU, "$(DISPLAY_UNIT)")
    field(SDIS, "$(P)DISABLE")
    field(INPA, "$(P)OUTPUT:PERSIST:CURR")
    field(INPB, "$(P)OUTPUT:PERSIST:FIELD:TESLA")
    field(INPC, "$(P)OUTPUT:PERSIST:FIELD:GAUSS")
    field(INPD, "$(DISPLAY_UNIT)")
    field(CALC, "D==\"AMPS\"?A:D==\"TESLA\"?B:C")
}

record(scalcout, "$(P)OUTPUT:PERSIST:CURR")
{
    field(DESC, "OUTPUT:PERSIST:RAW in Amps")
    field(INPA, "$(P)OUTPUT:PERSIST:RAW:UNIT")
    field(INPB, "$(P)OUTPUT:PERSIST:RAW")
    field(CALC, "A==\"AMPS\"?B:B*$(T_TO_A)")
}

record(scalcout, "$(P)OUTPUT:PERSIST:FIELD:GAUSS")
{
    field(DESC, "OUTPUT:PERSIST:RAW in Gauss")
    field(INPA, "$(P)OUTPUT:PERSIST:RAW:UNIT")
    field(INPB, "$(P)OUTPUT:PERSIST:RAW")
    field(CALC, "A==\"TESLA\"?B*10000:B*10000/$(T_TO_A)")
}

record(scalcout, "$(P)OUTPUT:PERSIST:FIELD:TESLA")
{
    field(DESC, "OUTPUT:PERSIST:RAW in Tesla")
    field(INPA, "$(P)OUTPUT:PERSIST:RAW:UNIT")
    field(INPB, "$(P)OUTPUT:PERSIST:RAW")
    field(CALC, "A==\"TESLA\"?B:B/$(T_TO_A)")
}

record(ai, "$(P)OUTPUT:PERSIST:RAW")
{
    field(DESC, "Raw persistent field from PSU, A or T")
}

record(ai, "$(P)OUTPUT:PERSIST:RAW:UNIT")
{
    field(DESC, "The unit for OUTPUT:PERSIST:RAW")
}

record(ai, "$(P)OUTPUT:RAW")
{
    field(DESC, "Raw value returned from the PSU, A or T")# returned during a “GO” command
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getOutput $(PORT)")
    field(PREC, "3")
    field(SCAN, ".5 second")
}

record(bi, "$(P)OUTPUT:RAW:UNIT")
{
    field(DESC, "The unit for OUTPUT:RAW") # returned as part of a “GO” command
    field(INP, "$(P)OUTPUTMODE")
}

record(ao, "$(P)OUTPUT:SP")
{
    field(DESC, "The destination of next ramp in $(DISPLAY_UNIT)")
    field(DTYP, "asynInt32")
    field(OUT, "@asyn($(ASYN_PORT),0,0)OUTPUT_SET")
    field(PREC, "3")
    field(EGU, "$(DISPLAY_UNIT)")
    field(SDIS, "$(P)DISABLE")
}

record(ai, "$(P)OUTPUT:VOLT")
{
    field(DESC, "The Output Voltage")
    field(EGU, "V")
    field(SIML, "SIM")
    field(SIOL, "SIM:OUTPUT")
    field(SDIS, "$(P)DISABLE")
}

record(mbbi, "$(P)OUTPUTMODE")
{
    field(DESC, "Reads output mode - amps or tesla")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getOutputMode $(PORT)")
    field(ZRVL, "0") field(ZRST, "AMPS")
    field(ONVL, "1") field(ONST, "TESLA")
    field(VAL, "0")
    field(SDIS, "$(P)DISABLE")
    field(SCAN, "1 second")
}

record(bo, "$(P)OUTPUTMODE:SP")
{
    field(DESC, "Set output mode - amps(0) or tesla(1)")
    field(DTYP, "asynInt32")
    field(OUT, "@asyn($(ASYN_PORT),0,0)OUTPUTMODE_SET")
    field(SCAN, "Passive")
    field(ZNAM, "AMPS")
    field(ONAM, "TESLA")
    field(VAL, "0")
    field(SDIS, "$(P)DISABLE")
}

record(bi, "$(P)PAUSE")
{
    field(DESC, "Whether the device is paused or not")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getPause $(PORT)")
    field(ZNAM, "OFF")
    field(ONAM, "ON")    
    field(SCAN, "Passive")
}

record(bo, "$(P)PAUSE:SP")
{
    field(DESC, "Pause the current ramp")
    field(SDIS, "$(P)DISABLE")
    field(DTYP, "asynInt32")
    field(OUT, "@asyn($(ASYN_PORT),0,0)PAUSE_SET")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

record(bo, "$(P)PAUSE:QUEUE")
{
    field(DESC, "Pause the queue")
    field(ZNAM, "OFF")
    field(ONAM, "ON")
}

### RAMP:

record(bo, "$(P)RAMP:LEADS")
{
    field(DESC, "Whether or not to ramp the leads")
    field(SDIS, "$(P)DISABLE")
}

record(ai, "$(P)RAMP:RATE")
{
    field(DESC, "The ramp rate stored by the device")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getRampRate $(PORT)")
    field(SCAN, "1 second")
}

record(stringout, "$(P)RAMP:RATE:SOURCE")
{
    field(DESC, "The source to use for the ramp rate")
}

record(scalcout, "$(P)RAMP:RAMPING")
{
    field(DESC, "Whether or not PSU is ramping")
    field(INPA, "$(P)RAMP:STAT")
    field(CALC, "A==0?1:0")
}

record(mbbi, "$(P)RAMP:STAT")
{
    field(DESC, "The status of the ramp from the PSU")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getRampStatus $(PORT)")
    field(SCAN, "1 second")
    field(ZRST, "RAMPING")
    field(ONST, "HOLDING ON TARGET")
    field(TWST, "HOLDING ON PAUSE")
    field(THST, "QUENCH TRIP")
    field(FRST, "EXTERNAL TRIP")
    field(FLNK, "$(P)FAN:STATUS")
}

record(ai, "$(P)RAMP:TARGET")
{
    field(DESC, "Ramp target read from device")
    field(DTYP, "stream")
    field(INP, "@cryosms.proto getRampTarget $(PORT)")
    field(SCAN, "I/O Intr")
    field(FLNK, "$(P)RAMP:TARGET:DISPLAY")
}

record(scalcout, "$(P)RAMP:TARGET:DISPLAY")
{
    field(DESC, "disp. unit version of RAMP:TARGET")
    field(INPA, "$(P)RAMP:TARGET")
    field(INPB, "$(DISPLAY_UNIT)")
    field(INPC, "$(WRITE_UNIT)")
    field(CALC, "B==C?A:B==\"TESLA\"?A/$(T_TO_A):A*$(T_TO_A)")
}

record(calc, "$(P)READY")
{
    field(DESC, "Whether the PSU is ready at the target")
    field(INPA, "$(P)RAMP:STAT")
    field(CALC, "A==1?1:0")
}

record(bo, "$(P)SIM")
{
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel")
    field(ZNAM, "NO")
    field(ONAM, "YES")
    field(VAL, "$(RECSIM=0)")
    field(PINI, "YES")
}


record(stringin, "$(P)STAT")
{
    field(DESC, "The latest status message")
}

record(bo, "$(P)START:SP")
{
    field(DESC, "Start a ramp to the current OUTPUT:SP")
    field(SDIS, "$(P)DISABLE")
}


### TARGET:

record(ai, "$(P)TARGET:TIME")
{
    field(DESC, "Time it will take to get to that target")
}

record(scalcout, "$(P)TARGET:SP")
{
    field(DESC, "Value to send PSU in $(WRITE_UNIT)")
    field(EGU, "$(WRITE_UNIT)")
}
### HIDDEN:

record(ao, "$(P)HIDDEN:CONSTANT:SP")
{
    field(DTYP, "stream")
    field(ASG, "HIDDEN")
    field(OUT, "@cryosms.proto setConstant $(PORT)")
    field(SCAN, "Passive")
}

record(ao, "$(P)HIDDEN:HEATER:VOLT:SP")
{
    field(DTYP, "stream")
    field(ASG, "HIDDEN")
    field(OUT, "@cryosms.proto setHeaterValue $(PORT)")
    field(SCAN, "Passive")
}


record(ao, "$(P)HIDDEN:MAX:SP")
{
    field(DTYP, "stream")
    field(ASG, "HIDDEN")
    field(OUT, "@cryosms.proto setMaxTarget $(PORT)")
    field(SCAN, "Passive")
}


record(bo, "$(P)HIDDEN:OUTPUTMODE:SP")
{
    field(DTYP, "stream")
    field(ASG, "HIDDEN")
    field(OUT, "@cryosms.proto setOutputMode $(PORT)")
    field(SCAN, "Passive")
    field(ZNAM, "AMPS")
    field(ONAM, "TESLA")
    field(VAL, "0")
}


record(ao, "$(P)HIDDEN:RAMP:RATE:SP")
{
    field(DTYP, "stream")
    field(ASG, "HIDDEN")
    field(OUT, "@cryosms.proto setRampRate $(PORT)")
    field(SCAN, "Passive")
}


### FANOUTS

record(fanout, "$(P)FAN:INIT")
{
    field(DESC, "Sends commands needed to init ioc")
    field(LNK1, "$(P)HEATER:STAT")
    field(LNK2, "$(P)DIRECTION")
    field(LNK3, "$(P)RAMP:RATE")
    field(LNK4, "$(P)OUTPUT:RAW")
    field(LNK5, "$(P)RAMP:STAT")
}

record(fanout, "$(P)FAN:STATUS")
{
    field(DESC, "Updates all ramp status bool PVs")
    field(LNK1, "$(P)READY")
    field(LNK2, "$(P)RAMP:RAMPING")
}

record(fanout, "$(P)FAN:UNITS")
{
    field(DESC, "Updates all output units")
    field(LNK1, "$(P)OUTPUT:RAW:UNIT")
}

### SIM

record(ai, "$(P)SIM:OUTPUT") {}
alias("$(P)SIM:OUTPUT", "$(P)SIM:OUTPUT:SP")
alias("$(P)SIM:OUTPUT:SP", "$(P)SIM:OUTPUT:SP:RBV")

record(mbbi, "$(P)SIM:OUTPUTMODE") {}
alias("$(P)SIM:OUTPUTMODE", "$(P)SIM:OUTPUTMODE:SP")
alias("$(P)SIM:OUTPUTMODE:SP", "$(P)SIM:OUTPUTMODE:SP:RBV")